name: Deploy to Live

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  compile:
    name: Compile TYPO3
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, json, pdo, pdo_mysql

      - name: Install Composer dependencies
        run: |
          cd source
          composer install --no-dev --optimize-autoloader --no-progress --no-interaction --ignore-platform-reqs

      - name: Upload source code (without vendor)
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: |
            source/
            !source/vendor
            !source/var
            !source/public/fileadmin
            !source/public/typo3temp
          retention-days: 1

      - name: Create vendor tarball (bypass gitignore)
        run: tar -czf /tmp/vendor.tar.gz -C source vendor/

      - name: Upload vendor tarball
        uses: actions/upload-artifact@v4
        with:
          name: vendor
          path: /tmp/vendor.tar.gz
          retention-days: 1

      - name: Create public tarball (bypass gitignore)
        run: tar -czf /tmp/public.tar.gz -C source public/

      - name: Upload public tarball
        uses: actions/upload-artifact@v4
        with:
          name: public
          path: /tmp/public.tar.gz
          retention-days: 1

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: compile
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download source code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      - name: Download vendor tarball
        uses: actions/download-artifact@v4
        with:
          name: vendor
          path: /tmp/

      - name: Extract vendor tarball
        run: tar -xzf /tmp/vendor.tar.gz -C source/

      - name: Download public tarball
        uses: actions/download-artifact@v4
        with:
          name: public
          path: /tmp/

      - name: Extract public tarball
        run: tar -xzf /tmp/public.tar.gz -C source/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=live
            type=raw,value=latest
            type=sha,prefix=live-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:live
          cache-to: type=inline

  deploy:
    name: Deploy to Live Server
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.LIVE_HOST }} >> ~/.ssh/known_hosts

      - name: Copy docker-compose and env files to server
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.LIVE_HOST }} "mkdir -p /var/www/binder-defence"
          scp docker-compose.live.yml ${{ secrets.PROD_USER }}@${{ secrets.LIVE_HOST }}:/var/www/binder-defence/docker-compose.live.yml

          # Copy .env.live if exists (don't overwrite existing .env)
          if [ -f .env.live ]; then
            ssh ${{ secrets.PROD_USER }}@${{ secrets.LIVE_HOST }} "test -f /var/www/binder-defence/.env.live || echo 'Create .env.live on server manually'"
          fi

      - name: Deploy on Live Server
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.LIVE_HOST }} << 'EOF'
            cd /var/www/binder-defence

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull new image
            export GITHUB_REPOSITORY="${{ github.repository }}"
            docker compose --env-file .env.live -f docker-compose.live.yml pull app

            # Restart container
            docker compose --env-file .env.live -f docker-compose.live.yml up -d app

            # Show logs
            docker compose --env-file .env.live -f docker-compose.live.yml logs --tail=50 app
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.PROD_USER }}@${{ secrets.LIVE_HOST }} "cd /var/www/binder-defence && docker compose --env-file .env.live -f docker-compose.live.yml ps"
