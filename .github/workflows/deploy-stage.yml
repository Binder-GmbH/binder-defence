name: Deploy to Stage

on:
  push:
    branches:
      - develop

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  compile:
    name: Compile TYPO3
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, json, pdo, pdo_mysql

      - name: Install Composer dependencies
        run: |
          cd source
          composer install --no-dev --optimize-autoloader --no-progress --no-interaction --ignore-platform-reqs

      - name: Debug - Check what was installed
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== source/ exists? ==="
          ls -la source/ || echo "No source/ in root"
          echo "=== source/vendor/ size ==="
          du -sh source/vendor/ 2>&1 || echo "No source/vendor/"
          echo "=== source/vendor/ contents (first 20) ==="
          ls -la source/vendor/ 2>&1 | head -20 || echo "Cannot list"
          echo "=== source/vendor/bin/ ==="
          ls -la source/vendor/bin/ 2>&1 || echo "No bin/"

      - name: Upload source code (without vendor)
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: |
            source/
            !source/vendor
            !source/var
            !source/public/fileadmin
            !source/public/typo3temp
          retention-days: 1

      - name: Upload vendor directory separately
        uses: actions/upload-artifact@v4
        with:
          name: vendor
          path: source/vendor/
          retention-days: 1

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: compile
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download source code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      - name: Download vendor directory
        uses: actions/download-artifact@v4
        with:
          name: vendor
          path: source/vendor/

      - name: Debug - List files
        run: |
          echo "=== Root directory ==="
          ls -la
          echo "=== source/ directory ==="
          ls -la source/ || echo "source/ not found"
          echo "=== source/vendor/ directory ==="
          ls -la source/vendor/ || echo "source/vendor/ not found"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=stage
            type=sha,prefix=stage-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:stage
          cache-to: type=inline

  deploy:
    name: Deploy to Stage Server
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.STAGE_HOST }} >> ~/.ssh/known_hosts

      - name: Copy docker-compose and env files to server
        run: |
          ssh ${{ secrets.STAGE_USER }}@${{ secrets.STAGE_HOST }} "mkdir -p /var/www/binder-defence"
          scp docker-compose.stage.yml ${{ secrets.STAGE_USER }}@${{ secrets.STAGE_HOST }}:/var/www/binder-defence/docker-compose.stage.yml

          # Copy .env.stage if exists (don't overwrite existing .env)
          if [ -f .env.stage ]; then
            ssh ${{ secrets.STAGE_USER }}@${{ secrets.STAGE_HOST }} "test -f /var/www/binder-defence/.env.stage || echo 'Create .env.stage on server manually'"
          fi

      - name: Deploy on Stage Server
        run: |
          ssh ${{ secrets.STAGE_USER }}@${{ secrets.STAGE_HOST }} << 'EOF'
            cd /var/www/binder-defence

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull new image
            export GITHUB_REPOSITORY="${{ github.repository }}"
            docker compose --env-file .env.stage -f docker-compose.stage.yml pull app

            # Restart container
            docker compose --env-file .env.stage -f docker-compose.stage.yml up -d app

            # Show logs
            docker compose --env-file .env.stage -f docker-compose.stage.yml logs --tail=50 app
          EOF

      - name: Verify deployment
        run: |
          ssh ${{ secrets.STAGE_USER }}@${{ secrets.STAGE_HOST }} "cd /var/www/binder-defence && docker compose --env-file .env.stage -f docker-compose.stage.yml ps"
